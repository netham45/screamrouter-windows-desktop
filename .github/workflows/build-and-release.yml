name: Build and Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Needed for creating releases
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Need full history for commit details
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
    
    - name: Restore dependencies
      run: dotnet restore ScreamRouterDesktop/ScreamRouterDesktop.csproj
    
    - name: Build
      run: dotnet build ScreamRouterDesktop/ScreamRouterDesktop.csproj --configuration Release --no-restore

    - name: Install Windows SDK
      run: |
        choco install windows-sdk-10-version-2004-all

    - name: Install Certificate
      run: |
        echo "${{ secrets.SCREAMROUTER_DESKTOP_PFX_B64 }}" | base64 --decode > certificate.pfx
      shell: bash
        
    - name: Sign Application
      run: |
        "C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe" sign /f certificate.pfx /p "${{ secrets.SCREAMROUTER_DESKTOP_PFX_B64_PASSWORD }}" /v /fd SHA256 ScreamRouterDesktop/bin/Release/net8.0-windows/ScreamRouterDesktop.exe
    
    - name: Get short commit hash
      id: commit
      shell: bash
      run: echo "shortcode=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
    
    - name: Create release artifacts directory
      run: mkdir release-artifacts
    
    - name: Copy release files
      run: |
        Copy-Item ScreamRouterDesktop/bin/Release/net8.0-windows/* -Destination release-artifacts/ -Recurse

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path release-artifacts/* -DestinationPath ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.zip
    
    # Install WiX Toolset for MSI creation
    - name: Install WiX Toolset
      run: |
        dotnet tool install --global wix --version 5.0.0
        wix extension add WixToolset.UI.wixext/5.0.0 -g
        wix extension add WixToolset.Util.wixext/5.0.0 -g
    
    # Prepare for MSI creation
    - name: Copy WiX files to release-artifacts
      run: |
        Copy-Item ScreamRouterDesktop/installer/ScreamRouterDesktop.wxs -Destination release-artifacts/installer.wxs
        Copy-Item ScreamRouterDesktop/License.rtf -Destination release-artifacts/
    
    # Build MSI
    - name: Build MSI Installer
      working-directory: release-artifacts
      run: |
        # Use a WiX-compatible version format (must be numeric only for the 4th part)
        $buildNumber = 1  # Use a fixed number instead of commit hash
        
        # Update version number
        (Get-Content -Path installer.wxs) -replace 'Version="1.0.0.0"', "Version=`"1.0.0.$buildNumber`"" | Set-Content -Path installer.wxs
        
        # Build the MSI
        wix build -ext WixToolset.UI.wixext -ext WixToolset.Util.wixext -o ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.msi installer.wxs
        
        # Sign the MSI
        "C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\signtool.exe" sign /f ../certificate.pfx /p "${{ secrets.SCREAMROUTER_DESKTOP_PFX_B64_PASSWORD }}" /v /fd SHA256 "ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.msi"
        
        # Check if MSI was created and signed before trying to copy it
        if (Test-Path "ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.msi") {
            # Copy the signed MSI to the root directory
            Copy-Item "ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.msi" -Destination ../
        } else {
            echo "::error::MSI file was not created, check build logs"
            exit 1
        }
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.commit.outputs.shortcode }}
        name: Release ${{ steps.commit.outputs.shortcode }}
        files: |
          ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.zip
          ScreamRouterDesktop-${{ steps.commit.outputs.shortcode }}.msi
        draft: false
        prerelease: false
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}
